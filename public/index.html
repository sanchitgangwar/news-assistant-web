<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telugu PDF â†’ English</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text);} 
    .container{max-width:900px; margin:40px auto; padding:24px;}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35);} 
    h1{font-size:1.6rem; margin:0 0 8px}
    p.sub{color:var(--muted); margin-top:0}
    .upload-area{margin:20px 0; border:2px dashed #374151; border-radius:16px; padding:60px 20px; text-align:center; cursor:pointer; transition:background .2s, border-color .2s;}
    .upload-area:hover{background:#1e293b; border-color:var(--accent);}
    .upload-area input[type=file]{display:none;}
    .upload-area label{display:block; color:var(--accent); font-weight:600; font-size:1.2rem; cursor:pointer;}
    button{background:var(--accent); color:#0a0f1a; border:0; padding:12px 20px; border-radius:12px; font-weight:700; cursor:pointer; margin-top:10px; font-size:1rem;}
    button[disabled]{opacity:.6; cursor:not-allowed}
    .log{margin-top:18px; padding:14px; background:#0b1220; border:1px solid #1f2937; border-radius:12px; height:300px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; white-space:pre-wrap}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .muted{color:var(--muted)}
    .badge{background:#0e7490; color:white; font-size:12px; padding:2px 8px; border-radius:999px}
    .footer{margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    a.download{color:#a7f3d0; text-decoration:none; font-weight:700}
    .snchg{display: flex; align-items: center; justify-content: center; color: #333}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Telugu News Clippings â†’ English</h1>
      <p class="sub">Upload a Telugu newspaper clippings PDF, with one clipping per page. The translation will stream live below, followed by a download link.</p>

      <form id="form">
        <div class="upload-area" id="upload-area">
          <label for="pdf">ðŸ“„ Click or Drop your PDF here</label>
          <input type="file" id="pdf" name="pdf" accept="application/pdf" required />
        </div>
        <div style="text-align:center;">
          <!-- start disabled until a file is chosen -->
          <button id="start" type="submit" disabled>Start Translation</button>
        </div>
      </form>

      <div class="row" style="margin-top:10px">
        <div class="muted">Status: <span id="status" class="badge">idle</span></div>
        <div class="muted" id="tip">Tip: keep this tab open to see live logs.</div>
      </div>

      <div id="log" class="log" aria-live="polite"></div>

      <div class="footer">
        <div class="muted">Output: <span id="result">(none yet)</span></div>
        <div><a id="pdf-download" class="download" href="#" style="display:none">Download translated PDF</a></div>
        <div><a id="csv-download" class="download" href="#" style="display:none">Download CSV</a></div>
      </div>
    </div>

    <div><p class="snchg">snchg</p></div>
  </div>

  <script>
    const form = document.getElementById('form');
    const pdfInput = document.getElementById('pdf');
    const uploadArea = document.getElementById('upload-area');
    const startBtn = document.getElementById('start');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const resultEl = document.getElementById('result');
    const pdfDownloadEl = document.getElementById('pdf-download');
    const csvDownloadEl = document.getElementById('csv-download');

    const defaultLabelText = 'ðŸ“„ Click or Drop your PDF here';
    const labelEl = uploadArea.querySelector('label');

    let sse = null;

    // ---------- UI helpers ----------
    function setStatus(text, color){
      statusEl.textContent = text;
      statusEl.style.background = color || '#0e7490';
    }
    function appendLog(line){
      const atBottom = logEl.scrollTop + logEl.clientHeight >= logEl.scrollHeight - 5;
      logEl.textContent += line + '\n';
      if (atBottom) logEl.scrollTop = logEl.scrollHeight;
    }
    function hideDownloads(){
      pdfDownloadEl.style.display = 'none';
      csvDownloadEl.style.display = 'none';
      pdfDownloadEl.removeAttribute('href');
      csvDownloadEl.removeAttribute('href');
    }
    function enterIdleMode(){
      // Button is for starting a translation; disabled until a file is chosen
      startBtn.textContent = 'Start Translation';
      startBtn.disabled = !pdfInput.files.length;
      startBtn.dataset.mode = 'start';
    }
    function enterTranslatingMode(){
      startBtn.textContent = 'Translatingâ€¦';
      startBtn.disabled = true;
      startBtn.dataset.mode = 'busy';
    }
    function enterCompletedMode(){
      // After job completes, allow user to reset
      startBtn.textContent = 'Start New Translation';
      startBtn.disabled = false;
      startBtn.dataset.mode = 'reset';
    }
    function resetUI(){
      // Clear file input
      pdfInput.value = '';
      labelEl.textContent = defaultLabelText;

      // Clear outputs
      logEl.textContent = '';
      resultEl.textContent = '(none yet)';
      setStatus('idle');
      hideDownloads();

      // Close any open stream
      if (sse) { try { sse.close(); } catch {} sse = null; }

      // Back to idle state
      enterIdleMode();
    }

    // ---------- Drag & drop and click ----------
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.background = '#1e293b';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.background = 'none';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.background = 'none';
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/pdf') {
        pdfInput.files = e.dataTransfer.files;
        labelEl.textContent = `âœ… ${file.name}`;
        startBtn.disabled = false; // now we have a file
      } else {
        alert('Please drop a valid PDF file');
      }
    });
    uploadArea.addEventListener('click', (e) => {
      pdfInput.click();
    });

    // Enable the start button when a file is chosen via picker
    pdfInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        labelEl.textContent = `âœ… ${file.name}`;
        startBtn.disabled = false;
      } else {
        labelEl.textContent = defaultLabelText;
        startBtn.disabled = true;
      }
    });

    // ---------- Button click: support start/reset modes ----------
    startBtn.addEventListener('click', (e) => {
      const mode = startBtn.dataset.mode || 'start';
      if (mode === 'reset') {
        // User wants a fresh run
        e.preventDefault();
        resetUI();
      }
      // 'start' and 'busy' fall through to form submit handler
    });

    // ---------- Submit: run translation ----------
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = pdfInput.files[0];
      if (!file) return;

      enterTranslatingMode();
      setStatus('uploading...', '#6b7280');
      logEl.textContent = '';
      resultEl.textContent = '(processing...)';
      hideDownloads();

      try {
        const body = new FormData();
        body.append('pdf', file);
        const res = await fetch('/upload', { method: 'POST', body });
        if (!res.ok) throw new Error('Upload failed');
        const { jobId } = await res.json();

        setStatus('running', '#f59e0b');
        appendLog(`[client] job ${jobId} started`);

        sse = new EventSource(`/stream/${jobId}`);
        sse.addEventListener('log', (ev) => {
          try {
            const { type, message } = JSON.parse(ev.data);
            appendLog(`[${type}] ${String(message).replace(/\n+$/, '')}`);
          } catch {
            appendLog(`[log] ${ev.data}`);
          }
        });
        sse.addEventListener('done', (ev) => {
          try {
            const { ok, code, downloadUrls } = JSON.parse(ev.data);

            if (ok && downloadUrls) {
              setStatus('finished', '#10b981');
              resultEl.textContent = 'Ready';
              if (downloadUrls.pdf) {
                pdfDownloadEl.href = downloadUrls.pdf;
                pdfDownloadEl.style.display = 'inline-block';
              }
              if (downloadUrls.csv) {
                csvDownloadEl.href = downloadUrls.csv;
                csvDownloadEl.style.display = 'inline-block';
              }
              appendLog(`[server] done (code=${code}). Downloads prepared.`);
            } else {
              setStatus('failed', '#ef4444');
              resultEl.textContent = 'Failed';
              appendLog(`[server] job failed (code=${code}).`);
            }
          } catch (err) {
            setStatus('error', '#ef4444');
            appendLog('[client] failed to parse completion event: ' + err.message);
          } finally {
            if (sse) { sse.close(); sse = null; }
            enterCompletedMode(); // <-- switch button to "Start New Translation"
          }
        });
        sse.addEventListener('error', (err) => {
          appendLog('[eventsource] connection error.');
        });

      } catch (err) {
        console.error(err);
        setStatus('error', '#ef4444');
        appendLog('[client] ' + err.message);
        enterCompletedMode(); // let user reset easily even after error
      }
    });

    // Initialize
    enterIdleMode();
  </script>
</body>
</html>
